---
title: "Estimate total basal area of seedlings from the second recent census"
author: 'eleanorjackson'
date: '`r format(Sys.time(), "%d %B, %Y")`' 
format: 
  gfm:
    toc: true
editor: source
execute:
  warning: false
---

```{r setup}
#| include: false

file_name <- knitr::current_input()

knitr::opts_chunk$set(
  fig.path =
    paste0("figures/", sub("\\.rmarkdown$", "", basename(file_name)), "/", sep = "")
)

set.seed(123)
ggplot2::theme_set(ggplot2::theme_classic(base_size = 10))
```

Replicating [2025-10-30_seedling-total-basal-area](2025-10-30_seedling-total-basal-area.md) 
for the second full SBE census.

```{r}
#| output: FALSE

library("tidyverse")
library("here")
library("patchwork")
```

```{r}
new_census <- 
  readRDS(here::here("data", "derived", "data_cleaned.rds")) %>% 
  filter(census_id == "full_measurement_02") # most recent census
```

Number of seedlings:

```{r}
new_census %>% 
  group_by(survival) %>% 
  summarise(n_seedlings = n_distinct(plant_id))
```

Note that seedlings which were never recorded as alive are not included here
(i.e., they died between planting and the first census, so we have no size data for them).

```{r}
new_census %>% 
  group_by(plot, treatment, survival) %>% 
  summarise(n_seedlings = n_distinct(plant_id),
            .groups = "drop") %>% 
  pivot_wider(names_from = survival, values_from = n_seedlings) %>% 
  rename(n_alive = `1`, n_dead = `0`) %>% 
  mutate(total = n_dead + n_alive) %>% 
  knitr::kable()
```

Mean and max seedling sizes:

```{r}
new_census %>% 
  filter(survival == 1) %>% 
  summarise(max_dbh = max(dbh_mm, na.rm = TRUE),
            mean_dbh = mean(dbh_mm, na.rm = TRUE),
            max_basal = max(dbase_mm, na.rm = TRUE),
            mean_basal = mean(dbase_mm, na.rm = TRUE)) %>% 
  knitr::kable()
```

Distribution of seedling sizes:

```{r}
new_census %>% 
  filter(survival == 1) %>% 
  ggplot(aes(x = dbh_mm)) +
  geom_density() +
  
  new_census %>% 
  filter(survival == 1) %>% 
  ggplot(aes(x = dbase_mm)) +
  geom_density()
```

```{r}
new_census %>% 
  filter(survival == 1) %>% # only alive seedlings
  summarise(n_distinct(plant_id))
```

Calculate basal area for each seedling using basal diameter measurements 

```{r}
seedling_ba <-
  new_census %>% 
  filter(survival == 1) %>% # only alive seedlings
  mutate(dbase_m = dbase_mm / 1000) %>% 
  mutate(basal_area = pi * (dbase_m/2)^2)
```

Summing basal area per treatment and calculating per ha

```{r}
seedling_ba %>% 
  group_by(treatment) %>% 
  summarise(sum_basal_area = sum(basal_area, na.rm = TRUE),
            n_plots = n_distinct(plot)) %>% 
  mutate(basal_area_per_ha = (sum_basal_area / n_plots)/4 ) %>% # 1 plot is 4ha
  knitr::kable()
```

```{r}
seedling_ba %>% 
  mutate(treatment_simplified = 
           case_when(treatment == "16-species-cut" ~ "lianas+planting",
                     .default = "planting")) %>% 
  group_by(treatment_simplified) %>% 
  summarise(sum_basal_area = sum(basal_area, na.rm = TRUE),
            n_plots = n_distinct(plot)) %>% 
  mutate(basal_area_per_ha = (sum_basal_area / n_plots)/4 ) %>% # 1 plot is 4ha 
  knitr::kable()
```
